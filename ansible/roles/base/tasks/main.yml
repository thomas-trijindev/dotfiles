---
- name: Update package cache (Arch/CachyOS)
  community.general.pacman:
    update_cache: yes
  when: ansible_facts['os_family'] == "Archlinux"

- name: Update package cache (Fedora)
  ansible.builtin.dnf:
    update_cache: yes
  when: ansible_facts['distribution'] == "Fedora"

- name: Update package cache (Ubuntu/Debian)
  ansible.builtin.apt:
    update_cache: yes
    cache_valid_time: 3600
  when: ansible_facts['os_family'] == "Debian"

- name: Update Homebrew (macOS)
  community.general.homebrew:
    update_homebrew: yes
  when: ansible_facts['os_family'] == "Darwin"
  become: no

- name: Install packages (Arch/CachyOS)
  community.general.pacman:
    name: "{{ packages_common + packages_arch }}"
    state: present
  when: ansible_facts['os_family'] == "Archlinux"

- name: Install packages (Fedora)
  ansible.builtin.dnf:
    name: "{{ packages_common + packages_fedora }}"
    state: present
  when: ansible_facts['distribution'] == "Fedora"

- name: Install packages (Ubuntu/Debian)
  ansible.builtin.apt:
    name: "{{ packages_common + packages_ubuntu }}"
    state: present
  when: ansible_facts['os_family'] == "Debian"

- name: Install packages (macOS)
  community.general.homebrew:
    name: "{{ packages_common + packages_macos }}"
    state: present
  when: ansible_facts['os_family'] == "Darwin"
  become: no

- name: Check if paru is installed (Arch/CachyOS)
  ansible.builtin.command: which paru
  register: paru_check
  changed_when: false
  failed_when: false
  when: ansible_facts['os_family'] == "Archlinux"

- name: Install paru dependencies (Arch/CachyOS)
  community.general.pacman:
    name:
      - base-devel
      - git
    state: present
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - paru_check.rc != 0

- name: Clone paru repository (Arch/CachyOS)
  ansible.builtin.git:
    repo: https://aur.archlinux.org/paru-bin.git
    dest: /tmp/paru-bin
    version: master
  become: yes
  become_user: "{{ primary_user }}"
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - paru_check.rc != 0

- name: Build and install paru (Arch/CachyOS)
  ansible.builtin.command:
    cmd: makepkg -si --noconfirm
    chdir: /tmp/paru-bin
  become: yes
  become_user: "{{ primary_user }}"
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - paru_check.rc != 0

- name: Check which AUR packages need to be installed (Arch/CachyOS)
  ansible.builtin.shell: |
    for pkg in {{ packages_aur | join(' ') }}; do
      if ! pacman -Qi "$pkg" &>/dev/null; then
        echo "$pkg"
      fi
    done
  register: aur_packages_needed
  changed_when: false
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - packages_aur is defined
    - packages_aur | length > 0

- name: Create AUR build directory (Arch/CachyOS)
  ansible.builtin.file:
    path: "/tmp/aur_builds"
    state: directory
    owner: "{{ primary_user }}"
    mode: '0755'
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - aur_packages_needed.stdout_lines | default([]) | length > 0

- name: Clone AUR packages (Arch/CachyOS)
  ansible.builtin.git:
    repo: "https://aur.archlinux.org/{{ item }}.git"
    dest: "/tmp/aur_builds/{{ item }}"
    version: master
  loop: "{{ aur_packages_needed.stdout_lines | default([]) }}"
  become: yes
  become_user: "{{ primary_user }}"
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - aur_packages_needed.stdout_lines | default([]) | length > 0

- name: Build AUR packages (Arch/CachyOS)
  ansible.builtin.shell: |
    cd /tmp/aur_builds/{{ item }} && makepkg -s --noconfirm --needed
  loop: "{{ aur_packages_needed.stdout_lines | default([]) }}"
  become: yes
  become_user: "{{ primary_user }}"
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - aur_packages_needed.stdout_lines | default([]) | length > 0

- name: Find built AUR packages (Arch/CachyOS)
  ansible.builtin.find:
    paths: "/tmp/aur_builds"
    patterns: "*.pkg.tar.zst"
    recurse: yes
  register: built_packages
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - aur_packages_needed.stdout_lines | default([]) | length > 0

- name: Install built AUR packages (Arch/CachyOS)
  community.general.pacman:
    name: "{{ built_packages.files | map(attribute='path') | list }}"
    state: present
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - built_packages.files | default([]) | length > 0

- name: Add user to nordvpn group (Arch/CachyOS)
  ansible.builtin.user:
    name: "{{ primary_user }}"
    groups: nordvpn
    append: yes
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - "'nordvpn-gui-bin' in packages_aur"

- name: Enable nordvpnd service (Arch/CachyOS)
  ansible.builtin.systemd:
    name: nordvpnd
    enabled: yes
    state: started
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - "'nordvpn-gui-bin' in packages_aur"

- name: Check if NordVPN is installed (Fedora)
  ansible.builtin.command: which nordvpn
  register: nordvpn_check_fedora
  changed_when: false
  failed_when: false
  when: ansible_facts['distribution'] == "Fedora"

- name: Install NordVPN repository (Fedora)
  ansible.builtin.shell: |
    sh <(curl -sSf https://downloads.nordcdn.com/apps/linux/install.sh) -n
  when:
    - ansible_facts['distribution'] == "Fedora"
    - nordvpn_check_fedora.rc != 0

- name: Install NordVPN (Fedora)
  ansible.builtin.dnf:
    name: nordvpn
    state: present
  when:
    - ansible_facts['distribution'] == "Fedora"
    - nordvpn_check_fedora.rc != 0

- name: Enable nordvpnd service (Fedora)
  ansible.builtin.systemd:
    name: nordvpnd
    enabled: yes
    state: started
  when: ansible_facts['distribution'] == "Fedora"

- name: Check if NordVPN is installed (Ubuntu/Debian)
  ansible.builtin.command: which nordvpn
  register: nordvpn_check_debian
  changed_when: false
  failed_when: false
  when: ansible_facts['os_family'] == "Debian"

- name: Install NordVPN repository (Ubuntu/Debian)
  ansible.builtin.shell: |
    sh <(curl -sSf https://downloads.nordcdn.com/apps/linux/install.sh) -n
  when:
    - ansible_facts['os_family'] == "Debian"
    - nordvpn_check_debian.rc != 0

- name: Install NordVPN (Ubuntu/Debian)
  ansible.builtin.apt:
    name: nordvpn
    state: present
    update_cache: yes
  when:
    - ansible_facts['os_family'] == "Debian"
    - nordvpn_check_debian.rc != 0

- name: Enable nordvpnd service (Ubuntu/Debian)
  ansible.builtin.systemd:
    name: nordvpnd
    enabled: yes
    state: started
  when: ansible_facts['os_family'] == "Debian"

- name: Install NordVPN (macOS)
  community.general.homebrew_cask:
    name: nordvpn
    state: present
  when: ansible_facts['os_family'] == "Darwin"
  become: no

- name: Check if chezmoi is installed
  ansible.builtin.command: which chezmoi
  register: chezmoi_check
  changed_when: false
  failed_when: false

- name: Install chezmoi (Arch/CachyOS)
  community.general.pacman:
    name: chezmoi
    state: present
  when:
    - ansible_facts['os_family'] == "Archlinux"
    - chezmoi_check.rc != 0

- name: Install chezmoi (Fedora)
  ansible.builtin.dnf:
    name: chezmoi
    state: present
  when:
    - ansible_facts['distribution'] == "Fedora"
    - chezmoi_check.rc != 0

- name: Install chezmoi (Ubuntu/Debian)
  ansible.builtin.shell: |
    sh -c "$(curl -fsLS get.chezmoi.io)" -- -b /usr/local/bin
  args:
    creates: /usr/local/bin/chezmoi
  when:
    - ansible_facts['os_family'] == "Debian"
    - chezmoi_check.rc != 0

- name: Install chezmoi (macOS)
  community.general.homebrew:
    name: chezmoi
    state: present
  when:
    - ansible_facts['os_family'] == "Darwin"
    - chezmoi_check.rc != 0
  become: no

- name: Check if Claude Code is installed
  ansible.builtin.command: which claude
  register: claude_check
  changed_when: false
  failed_when: false

- name: Install Claude Code
  ansible.builtin.shell: |
    curl -fsSL https://claude.ai/install.sh | bash
  become: yes
  become_user: "{{ primary_user }}"
  when: claude_check.rc != 0