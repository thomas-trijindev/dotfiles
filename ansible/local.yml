---
- name:  Configure System
  hosts: localhost
  connection: local
  become: yes

  vars_files:
    - group_vars/all.yml

  pre_tasks:
    - name: Gathering Details
      ansible.builtin.setup:
        gather_subset:
          - hardware
          - network
          - virtual

    - name: Get chassis type from hostnamectl (Linux)
      ansible.builtin.command: hostnamectl --json=short
      register: hostnamectl_output
      changed_when: false
      check_mode: false
      when: ansible_facts['os_family'] != "Darwin"

    - name: Set chassis fact (Linux)
      ansible.builtin.set_fact:
        detected_chassis: "{{ (hostnamectl_output.stdout | from_json).Chassis | default('unknown') }}"
      when: ansible_facts['os_family'] != "Darwin"

    - name: Set chassis fact (macOS)
      ansible.builtin.set_fact:
        detected_chassis: "{{ 'laptop' if ansible_facts['model'] is defined and 'MacBook' in ansible_facts['model'] else 'desktop' }}"
      when: ansible_facts['os_family'] == "Darwin"

    - name: Debug chassis
      ansible.builtin.debug:
        msg: "Chassis is: '{{ detected_chassis }}' - equals laptop: {{ detected_chassis == 'laptop' }}"

    - name: Detect Operating System
      ansible.builtin.debug:
        msg:  |
          OS Family: {{ ansible_facts['os_family'] }}
          Distribution: {{ ansible_facts['distribution'] }}
          Version: {{ ansible_facts['distribution_version'] }}
          Chassis: {{ detected_chassis }}

    - name: Get primary user UID
      ansible.builtin.command: id -u {{ primary_user }}
      register: primary_user_uid
      changed_when: false
      check_mode: false

    - name: Set user UID fact
      ansible.builtin.set_fact:
        primary_user_uid: "{{ primary_user_uid.stdout }}"

    - name: Enable swayidle user service (Linux only)
      ansible.builtin.systemd:
        name: swayidle.service
        enabled: yes
        state: started
        scope: user
      become: yes
      become_user: "{{ primary_user }}"
      environment:
        XDG_RUNTIME_DIR: "/run/user/{{ primary_user_uid }}"
      ignore_errors: yes
      when: ansible_facts['os_family'] != "Darwin"

  roles:
    - role: base
      tags: [base, packages]

#    - role: ssh
#      tags: [ssh, security]

#    - role: fingerprint  
#      tags: [fingerprint, auth]
#     when: fingerprint_enabled | default(true)

    - role: power
      tags: [power, laptop]
      when:
        - ansible_facts['os_family'] != "Darwin"
        - detected_chassis == 'laptop' or force_power_management | default(false)

  post_tasks:
    - name: Final message
      ansible.builtin.debug:
        msg: |
          ========================================
          System configuration complete!
          
          Chassis detected: {{ detected_chassis }}
          
          NEXT STEPS:
          1. Add SSH public key to ~/.ssh/authorized_keys
          2. Run 'fprintd-enroll' to register fingerprint
          3. Test SSH login before disconnecting
          4. Run 'chezmoi init --apply' as your user
          5. Reboot to apply all changes
          ========================================