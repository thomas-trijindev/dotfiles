---
- name:  Configure System
  hosts: localhost
  connection: local
  become: yes

  vars_files:
    - group_vars/all.yml

  pre_tasks:
    - name: Gathering Details
      ansible.builtin.setup:
        gather_subset:
          - hardware
          - network
          - virtual

    - name: Get chassis type from hostnamectl
      ansible.builtin.command: hostnamectl --json=short
      register: hostnamectl_output
      changed_when: false

    - name: Set chassis fact
      ansible.builtin.set_fact:
        detected_chassis: "{{ (hostnamectl_output.stdout | from_json).Chassis | default('unknown') }}"
      

    - name: Detect Operating System
      ansible.builtin.debug:
        msg:  |
          OS Family: {{ ansible_facts['os_family'] }}
          Distribution: {{ ansible_facts['distribution'] }}
          Version: {{ ansible_facts['distribution_version'] }}
          Chassis: {{ ansible_facts['chassis_type'] | default('unknown') }}

  roles:
    - role: base
      tags: [base, packages]

#    - role: ssh
#      tags: [ssh, security]

#    - role: fingerprint  
#      tags: [fingerprint, auth]
#     when: fingerprint_enabled | default(true)

#    - role: power
#      tags: [power, laptop]
#      when: ansible_chassis_type | default('') == 'laptop' or force_power_management | default(false)

  post_tasks:
    - name: Final message
      ansible.builtin.debug:
        msg: |
          ========================================
          System configuration complete!
          
          Chassis detected: {{ detected_chassis }}
          
          NEXT STEPS:
          1. Add SSH public key to ~/.ssh/authorized_keys
          2. Run 'fprintd-enroll' to register fingerprint
          3. Test SSH login before disconnecting
          4. Run 'chezmoi init --apply' as your user
          5. Reboot to apply all changes
          ========================================